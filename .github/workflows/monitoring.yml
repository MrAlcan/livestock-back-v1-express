# ==========================================
# MONITORING & MAINTENANCE WORKFLOW
# ==========================================
name: Monitoring

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # ------------------------------------------
  # Database Backup
  # ------------------------------------------
  backup:
    name: Automated Backup
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Run backup script
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd /opt/sgg-api
            ./scripts/backup.sh 30
          ENDSSH

      - name: Verify backup
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd /opt/sgg-api
            ls -lh backups/database/ | tail -5
          ENDSSH

  # ------------------------------------------
  # Health Check
  # ------------------------------------------
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Check API health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://sgg.com/health)
          if [ $response -ne 200 ]; then
            echo "Health check failed with status: $response"
            exit 1
          fi

      - name: Check database connectivity
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            docker-compose -f /opt/sgg-api/docker-compose.prod.yml exec -T postgres pg_isready
          ENDSSH

      - name: Check Redis connectivity
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            docker-compose -f /opt/sgg-api/docker-compose.prod.yml exec -T redis redis-cli ping
          ENDSSH

  # ------------------------------------------
  # Dependency Updates
  # ------------------------------------------
  dependency-updates:
    name: Check Dependency Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for updates
        run: |
          npm outdated || true

      - name: Create issue for updates
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies'
            });

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Dependency updates available',
                body: 'Run `npm outdated` to see available updates',
                labels: ['dependencies', 'maintenance']
              });
            }

  # ------------------------------------------
  # Security Scan
  # ------------------------------------------
  security-scan:
    name: Daily Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run security audit
        run: npm audit --audit-level=high

      - name: Notify on vulnerabilities
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: 'danger'
          text: 'Security vulnerabilities detected! Run npm audit for details.'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ------------------------------------------
  # Disk Space Check
  # ------------------------------------------
  disk-space:
    name: Check Disk Space
    runs-on: ubuntu-latest

    steps:
      - name: Check disk usage
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            df -h | grep -E '^/dev/' | awk '{
              use = substr($5, 1, length($5)-1);
              if (use > 80) {
                print "WARNING: Disk usage is at " use "%";
                exit 1;
              }
            }'
          ENDSSH

  # ------------------------------------------
  # Log Rotation
  # ------------------------------------------
  log-rotation:
    name: Rotate Logs
    runs-on: ubuntu-latest

    steps:
      - name: Rotate and compress logs
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd /opt/sgg-api/logs
            find . -name "*.log" -mtime +7 -exec gzip {} \;
            find . -name "*.log.gz" -mtime +30 -delete
          ENDSSH
